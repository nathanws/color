<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Color - Simple Color Palette</title>

		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

		<!-- Optional theme -->
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

		<!-- Latest compiled and minified JavaScript -->
		<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

		<style type="text/less">
			@background-color: #CECFC7;
			@swatchHeight: 100;
			@swatchWidth: 100;
		
			body {
				background-color: @background-color;
			}

			nav {
				&.navbar {
					border-radius: 0px;
				}
			}

			#palettes {
				margin-bottom: 25px;
			}

			.color-section {
				display: inline-block;
				border: 1px solid darken(@background-color, 20%);
				margin: 0 5px 5px 0px;
				padding: 5px;

				.swatch {
					height: unit(@swatchHeight, px);
					width: unit(@swatchWidth, px);

					background-color: #686A5B;
					margin-bottom: 5px;
				}

				.swatch-info {
					.hex {}

					.name {}

					.operations {
						.glyphicon {
							margin-left: 3px;
						}
					}

					.rgb {
						margin-bottom: 4px;
					}
				}
			}

			.pointer {
				cursor: pointer;
			}
		</style>

		<!-- LESS, because why not -->
		<script>
			less = {
				env: "development",
				async: false,
				fileAsync: false,
				poll: 1000,
				functions: {},
				dumpLineNumbers: "comments",
				relativeUrls: false
			};
		</script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.6.2/less.min.js"></script>

		<script>
			var swatchHeight = 100;
			var swatchWidth = 100;

			if (typeof(Storage) !== "undefined") {
				var savePalettes = function () {
					localStorage.setItem('palettes', JSON.stringify(exportPalettes()));
				};

				var loadPalettes = function () {
					return JSON.parse(localStorage.palettes || {});
				};
			} else {
				var savePalettes = function () {};
				var loadPalettes = function () {};
			}

			$(document).ready(function () {
				if (localStorage.palettes) {
					importPalettes(loadPalettes());
					$('#paletteSelect').val(localStorage.currentPalette);
				} else {
					var p = addPalette('Default Palette');
					localStorage.currentPalette = 'Default Palette';
				}

				refreshTooltips();

				$('#addBtn').click(function () {
					var c = getFormVals();
					// createSwatch(c).appendTo('#main-stuff');
					createSwatch(c).appendTo('[data-palette="' + localStorage.currentPalette + '"]');
					$('#addSwatchModal').modal('hide');
					refreshTooltips();
					savePalettes();
				});

				$('#addSwatchModal').on('shown.bs.modal', function (e) {
					$('#inputName').focus();
				}).on('hide.bs.modal', function (e) {
					clearForms();
				});

				$('#addPaletteBtn').click(function () {
					var p = $('#inputPaletteName').val() || null;
					var fg = $('#addPaletteModal .modal-body .form-group');

					if (p != null) {
						addPalette(p);
						savePalettes();
						loadPalette(p)
						$('#paletteSelect').val(p);
						fg.removeClass('has-error').find('help-block').addClass('hidden');
						$('#addPaletteModal').modal('hide');
					} else {
						fg.addClass('has-error').find('.help-block').removeClass('hidden');
					}
				});

				$('#addPaletteModal').on('show.bs.modal', function (e) {
					$('#inputPaletteName').focus();
				}).on('hide.bs.modal', function (e) {
					clearForms();
				});

				$('#deletePaletteBtn').click(function () {
					var p = $('#paletteSelect').val();
					$('[data-palette="' + p + '"]').remove();
					$('#paletteSelect option:selected').remove();
					savePalettes();
					loadPalette($('#paletteSelect').val());
				});

				$('#importBtn').click(function () {
					if ($('#deleteExistingCB').is(':checked')) {
						$('#main-stuff').empty();
						$('#paletteSelect').empty();
					}

					importPalettes(JSON.parse($('#swatchTextarea').val()));

					$('#exportModal').modal('hide');
					$('#deleteExistingCB').prop('checked', false)	

					savePalettes();
				});

				$('#inputBGColor').keyup(function () {
					var c = $(this).val();

					if (c[0] != '#') {
						c = '#' + c;
					}

					$('body').css('background-color', c);
				});

				$('#inputHex').keydown(function (e) {
					if (e.keyCode == 13) {
						$('#addBtn').click();	
					}
				});

				$('#inputSwatchHeight').keyup(function (e) {
					$('.color-section .swatch').css('height', $(this).val());
				});

				$('#inputSwatchWidth').keyup(function (e) {
					$('.color-section .swatch').css('width', $(this).val());
				});

				$('#paletteSelect').change(function () {
					loadPalette($(this).val());
				});

				$('#settingsModal').on('show.bs.modal', function (e) {
					$('#inputBGColor').attr('placeholder', rgb2hex($('body').css('background-color')));
					$('#inputSwatchHeight').attr('placeholder', $('.color-section .swatch').height() || swatchHeight);
					$('#inputSwatchWidth').attr('placeholder', $('.color-section .swatch').width() || swatchWidth);
				}).on('hide.bs.modal', function (e) {
					savePalettes();
				});

				$('#settingsResetBtn').click(function () {
					localStorage.settings = "{}";
					location.reload();
				});

				$('.exportPalettes').click(function (e) {
					e.preventDefault();
					$('#swatchTextarea').val(JSON.stringify(exportPalettes(), null, 4));
					$('#exportModal').modal('show');
				});

				$('.importPalettes').click(function (e) {
					e.preventDefault();
					$('#swatchTextarea').val('');
					$('#exportModal').modal('show');
				});
			});

			function addPalette(name) {
				var opts = $('#paletteSelect option');
				var newOpt = $('<option>').html(name);

				if (opts.length == 0) {
					newOpt.appendTo('#paletteSelect');
				} else {
					opts.each(function (i, opt) {
						if ($(opt).html().toLowerCase() > name.toLowerCase()) {
							newOpt.insertBefore($(opt));
							return false;
						} else if (i == opts.length - 1) {
							newOpt.insertAfter($(opt));
						}
					});	
				}

				var palette = $('<div>')
					.addClass('palette')
					.attr('data-palette', name)
					.attr('data-palette-bgcolor', rgb2hex($('body').css('background-color')))
					.appendTo('#main-stuff');

				return palette;
			}

			function clearForms() {
				$('#inputName').val('');
				$('#inputHex').val('');
				$('#inputPaletteName').val('');
			}

			function createSwatch(opts) {
				var outer = $("<div>").addClass('color-section');

				if (opts.hex[0] != '#') {
					opts.hex = '#' + opts.hex;
				}

				var settings = loadPalettes()[localStorage.currentPalette].settings;
				
				var swatch = $('<div>').addClass('swatch')
					.css('background-color', opts.hex)
					.css('height', settings.swatchHeight || swatchHeight)
					.css('width', settings.swatchWidth || swatchWidth)
					.appendTo(outer);

				var swatchInfo = $('<div>').addClass('swatch-info').appendTo(outer);
				var name = $('<div>').addClass('name text-center').html(opts.name).appendTo(swatchInfo);
				var hex = $('<div>').addClass('hex text-center').html(opts.hex).appendTo(swatchInfo);

				var ops = $('<div>').addClass('operations text-right').appendTo(swatchInfo);
				var darken = $('<span>').addClass('glyphicon glyphicon-arrow-down pointer')
								.attr('data-toggle', 'tooltip')
								.attr('data-placement', 'top')
								.attr('title', 'darken')
								.click(function () {
									darkenSwatch($(this).parents('.color-section'));
									savePalettes();
								})
								.appendTo(ops);

				var lighten = $('<span>').addClass('glyphicon glyphicon-arrow-up pointer')
								.attr('data-toggle', 'tooltip')
								.attr('data-placement', 'top')
								.attr('title', 'lighten')
								.click(function () {
									lightenSwatch($(this).parents('.color-section'));	
									savePalettes();
								})
								.appendTo(ops);

				var duplicate = $('<span>').addClass('glyphicon glyphicon-new-window pointer')
								.attr('data-toggle', 'tooltip')
								.attr('data-placement', 'top')
								.attr('title', 'duplicate')
								.click(function () {
									createSwatch(getSwatch($(this).parents('.color-section'))).appendTo($('[data-palette="' + localStorage.currentPalette + '"]'));
									savePalettes();
								})
								.appendTo(ops);

				var remove = $('<span>').addClass('glyphicon glyphicon-remove pointer')
								.attr('data-toggle', 'tooltip')
								.attr('data-placement', 'top')
								.attr('title', 'remove')
								.click(function() {
									removeSwatch(this);
									savePalettes();
								})
								.appendTo(ops);

				return outer;
			}

			function darkenSwatch(elm) {
				var swatch = getSwatch(elm);
				var c = new less.tree.Color(swatch.hex);
				var a = new less.tree.Value('10');	// darken by 10%
				var r = less.tree.functions.darken(c, a);

				$(elm).find('.swatch').css('background-color', r.toRGB());
				$(elm).find('.swatch-info .hex').text(r.toRGB());
			}

			function exportPalettes() {
				var palettes = {};

				$('#main-stuff .palette').each(function (index, value) {
					var p = $(value);
					var palette = {};
					palette["name"] = p.attr('data-palette');
					palette["settings"] = {};
					palette.settings["backgroundColor"] = p.attr('data-palette-bgcolor');
					palette.settings["swatchHeight"] = p.find('.swatch').height();
					palette.settings["swatchWidth"] = p.find('.swatch').width();
					palette["swatches"] = [];

					$('[data-palette="' + palette.name + '"] .color-section').each(function (index, value) {
						palette.swatches[index] = getSwatch(this);
					});

					palettes[palette.name] = palette;
				});

				return palettes;
			}

			function getFormVals() {
				return {
					name: $('#inputName').val(),
					hex: $('#inputHex').val()
				};
			}

			function getSwatch(elm) {
				var parent = $(elm);

				var hex = parent.find('.swatch-info .hex').text();
				if (hex[0] == '#') {
					hex = hex.substring(1);
				}

				return {
					'hex': hex,
					'name': parent.find('.swatch-info .name').text()
				}
			}

			function importPalettes(palettes) {
				var keys = Object.keys(palettes);

				if (keys.length > 0) {
					var currentPalette = localStorage.currentPalette;

					for (var i = 0; i < keys.length; i++) {
						var palette = palettes[keys[i]];

						var outer = addPalette(palette.name);
						outer.attr('data-palette-bgcolor', palette.settings.backgroundColor)

						if (currentPalette && palette.name != currentPalette) {
							outer.addClass('hidden');
						}

						for (var j = 0; j < palette.swatches.length; j++) {
							createSwatch(palette.swatches[j]).appendTo(outer);
						}

						outer.find('.color-section .swatch')
							.css('height', palette.settings.swatchHeight)
							.css('width', palette.settings.swatchWidth);
					}

					if (!currentPalette) {
						loadPalette($('#main-stuff .palette').first().attr('data-palette'));
					}
				}
			}

			function lightenSwatch(elm) {
				var swatch = getSwatch(elm);
				var c = new less.tree.Color(swatch.hex);
				var a = new less.tree.Value('10');	// lighten by 10%
				var r = less.tree.functions.lighten(c, a);

				$(elm).find('.swatch').css('background-color', r.toRGB());
				$(elm).find('.swatch-info .hex').text(r.toRGB());
			}

			function loadPalette(paletteName) {
				$('#main-stuff .palette').addClass('hidden');
				$('[data-palette="' + paletteName + '"]').removeClass('hidden');	

				localStorage.setItem('currentPalette', paletteName);
				var palettes = loadPalettes();

				$('body').css('background-color', palettes[paletteName].settings.backgroundColor);
			}

			function refreshTooltips() {
				$('[data-toggle="tooltip"]').tooltip();
			}

			function removeSwatch(swat) {
				$(swat).parents('.color-section').remove();
			}

			function rgb2hex(rgb) {
				rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);

				function hex(x) {
					return ("0" + parseInt(x).toString(16)).slice(-2);
				} 

				return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
			}	
		</script>
	</head>

	<body>
		<nav class="navbar navbar-inverse" role="navigation">

			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#color-navbar-collapse">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="">Color</a>
				</div>

				<div class="collapse navbar-collapse" id="color-navbar-collapse">
					<ul class="nav navbar-nav navbar-right">
						<li>
							<a href="" class="exportPalettes">Export Palettes</a>
						</li>
						<li>
							<a href="" class="importPalettes">Import Palettes</a>
						</li>
						<li>
							<a href="" class="settings-btn glyphicon glyphicon-cog hidden-xs" data-toggle="modal" data-target="#settingsModal"></a>
							<a href="" class="settings-btn visible-xs" data-toggle="modal" data-target="#settingsModal">Settings</a>
						</li>
						<li>
							<a href="" id="addNewColorBtn" data-toggle="modal" data-target="#addSwatchModal">Add New Color</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<div id="palettes" class="container">
			<div class="row">
				<div class="col-lg-5">
					<div class="input-group">
						<select id="paletteSelect" class="form-control"></select>
						<span class="input-group-btn">
							<button class="btn btn-default" type="button" data-toggle="modal" data-target="#addPaletteModal">
								<span class="glyphicon glyphicon-plus" data-toggle="tooltip" data-placemen="bottom" title="Add Palette"></span>
							</button>
							<button id="deletePaletteBtn" class="btn btn-default" type="button" data-toggle="tooltip" data-placement="bottom" title="Delete Palette">
								<span class="glyphicon glyphicon-remove" ></span>
							</button>
						</span>
					</div>
				</div>
			</div>
		</div>

		<div id="main-stuff" class="container"></div>

		<!-- ADD SWATCH MODAL -->
		<div id="addSwatchModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Add Color</h4>
					</div>

					<div class="modal-body">
						<form class="form-horizontal" role="form">
							<div class="form-group">
								<label for="inputName" class="col-lg-2 control-label">Name</label>
								<div class="col-lg-10">
									<input type="text" class="form-control" id="inputName" placeholder="Name">
								</div>
							</div>

							<div class="form-group">
								<label for="inputHex" class="col-lg-2 control-label">Hex</label>
								<div class="col-lg-10">
									<div class="input-group">
										<span class="input-group-addon">#</span>
										<input type="text" class="form-control" id="inputHex" placeholder="Hex">
									</div>
								</div>
							</div>
						</form>
					</div>

					<div class="modal-footer">
						<button id="closeAddBtn" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button id="addBtn" type="button" class="btn btn-primary">Add</button>
					</div>
				</div>
			</div>
		</div>

		<!-- ADD PALETTE MODAL -->
		<div id="addPaletteModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Add Palette</h4>
					</div>

					<div class="modal-body">
						<form class="form-horizontal" role="form">
							<div class="form-group">
								<div class="col-lg-12">
									<input type="text" class="form-control" id="inputPaletteName" placeholder="Name">
									<span class="help-block hidden">Please enter a Palette name</span>
								</div>
							</div>
						</form>
					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button id="addPaletteBtn" type="button" class="btn btn-primary">Add</button>
					</div>
				</div>
			</div>
		</div>

		<!-- EXPORT/IMPORT MODAL -->
		<div id="exportModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Swatches</h4>
					</div>

					<div class="modal-body">
						<textarea id="swatchTextarea" class="form-control" rows="10"></textarea>

						<div class="checkbox">
							<label>
								<input type="checkbox" id="deleteExistingCB"> Delete existing swatches on load?
							</label>
						</div>
					</div>

					<div class="modal-footer">
						<button id="closeExportBtn" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button id="importBtn" type="button" class="btn btn-primary">Load</button>
					</div>
				</div>
			</div>
		</div>

		<!-- SETTINGS MODAL -->
		<div id="settingsModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Settings</h4>
					</div>

					<div class="modal-body">
						<form class="form-horizontal" role="form">
							<div class="form-group">
								<label for="inputBGColor" class="col-lg-4 control-label">Background Color</label>
								<div class="col-lg-8">
									<div class="input-group">
										<span class="input-group-addon">#</span>
										<input type="text" class="form-control" id="inputBGColor" placeholder="#CECFC7" value="">
									</div>
								</div>
							</div>

							<div class="form-group">
								<label class="col-lg-4 control-label">Swatch Size</label>
								<div class="col-lg-8">
									<div class="row">
										<div class="col-lg-2 control-label">
											Width
										</div>
										<div class="col-lg-5">
											<div class="input-group">
												<input type="text" class="form-control" id="inputSwatchWidth" placeholder="100">
												<span class="input-group-addon">px</span>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div class="form-group">
								<div class="col-lg-8 col-lg-offset-4">
									<div class="row">
										<div class="col-lg-2 control-label">
											Height
										</div>
										<div class="col-lg-5">
											<div class="input-group">
												<input type="text" class="form-control" id="inputSwatchHeight" placeholder="100">
												<span class="input-group-addon">px</span>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div class="form-group">
								<div class="col-lg-8 col-lg-offset-4">
									<button id="settingsResetBtn" type="button" class="btn btn-danger btn-block">Reset all Settings to default</button>
								</div>
							</div>
						</form>
					</div>

					<div class="modal-footer">
						<button id="closeSettingsBtn" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>